Consider starting a newly added tab a an active docshell
I have been debugging some test failure with my patch for bug 1343728 for week now and I finally found out the reason for why the failure happen!

Consider this try push: https://treeherder.mozilla.org/#/jobs?repo=try&revision=514c0110a4a5b441bd9eafc276988ca2f12e68d5&selectedJob=93751442 There are many test failure but they're all of similar nature but I have picked layout/style/test/test_animations_effect_timing_duration.html for debugging. What generally happens is that we we try to open a test page in a new tab, the test page run some script during page load which do something like call nsIDOMWindowUtils.advanceTimeAndRefresh() which run a refresh driver tick from JS. The refresh driver tick end up calling nsViewManager::ProcessPendingUpdatesPaint() since my patch is removing the create window sync IPC, now this code in the content process is running very much earlier than before, much earlier before the parent ha actually opened a tab, and it turn out that the docshell isn't marked a active yet, so our widget think that we don't need to paint and this return false <https://searchfox.org/mozilla-central/rev/6580dd9a4eb0224773897388dba2ddf5ed7f4216/view/nsViewManager.cpp#445> and we bail out early without every calling PresShell::Paint() and actually painting something. Then the test listens for a MozAfterPaint event which will arrive but since no actual painting will happen the MozAfterPaint will have an empty invalidated rect which will cause the test to fail. If you modify this test to open it test page in a new window (which is also changed by my patches) the test works.

I finally narrowed this down to this code: <https://searchfox.org/mozilla-central/rev/6580dd9a4eb0224773897388dba2ddf5ed7f4216/browser/base/content/tabbrowser.xml#2201> This code is very old, it date back to bug 343515, and to the first WIP patch there (attachment 401797) and a far a I can tell there wa no specific reason why this wa done this way. The specific thing that cause this test failure is that due to this line, when we get to ProcessPengingUpdatesPaint() above our widget think it doesn't need painting. I see no reason why we can't change this to true.

I sent a patch to do that on top of my old try push to the try server last night and it seemed to work out well: https://treeherder.mozilla.org/#/jobs?repo=try&revision=a32776f3a5c6e88a2f262278f6d8214f4645de9b There are other test failure a a result of this (for example the test for bug 343515 and a few other thing that depend on the current behavior break but that's not unexpected.)

Before I spent the time to chase down these test failure and fix them, Mike, do you think it's reasonable to start out the docshell a active in _insertBrowser()?
