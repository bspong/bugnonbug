Building Firefox with clang and -flto makes the libxul.so gtest fail: NSModules are not ordered appropriately
On automation libxul.so is built twice. Once before the gtest and once during the gtest. After the second build, the test for the order of NSModules fails.

I think the problem is that StaticXULComponentsStart.o is missing from the beginning of the compilation line of libxul.so in the gtest.

So removing it from libxul_s.a and putting at the beginning should fix it.

* Current compilation line that fails the NSModules order test:

/home/worker/workspace/build/src/obj-firefox/_virtualenv/bin/python /home/worker/workspace/build/src/config/expandlibs_exec.py --uselist --  /usr/bin/ccache /home/worker/workspace/build/src/clang/bin/clang++ -std=gnu++11 -Qunused-arguments  -Qunused-arguments -Wall -Wc++11-compat -Wempty-body -Wignored-qualifiers -Woverloaded-virtual -Wpointer-arith -Wsign-compare -Wtype-limits -Wunreachable-code -Wwrite-strings -Wc++11-compat-pedantic -Wc++14-compat -Wc++14-compat-pedantic -Wc++1z-compat -Wclass-varargs -Wimplicit-fallthrough -Wloop-analysis -Werror=non-literal-null-conversion -Wstring-conversion -Wthread-safety -Wno-invalid-offsetof -Wno-inline-new-delete -Wno-error=deprecated-declarations -Wno-error=array-bounds -Wno-unknown-warning-option -Wno-return-type-c-linkage -O2 -flto -fsanitize=cfi-vcall -fsanitize-cfi-cross-dso -fno-exceptions -fno-strict-aliasing -fno-rtti -ffunction-sections -fdata-sections -fno-exceptions -fno-math-errno -pthread -D_GLIBCXX_USE_CXX11_ABI=0 -pipe  -g -fno-omit-frame-pointer  -Werror -fPIC -shared -Wl,-h,libxul.so -o libxul.so   librul.a   -lpthread -O2 -flto -fsanitize=cfi-vcall -fsanitize-cfi-cross-dso -ldl -Wl,-z,noexecstack -Wl,-z,text -Wl,--build-id -Wl,-version-script,symverscript    -Wl,-rpath-link,/home/worker/workspace/build/src/obj-firefox/dist/bin -Wl,-rpath-link,/usr/local/lib  ../../../memory/volatile/tests/libmemory_volatile_tests.a ../../../media/libstagefright/gtest/libstagefright_gtest.a ../../../security/sandbox/linux/gtest/libsandboxtest.a ../../../security/pkix/test/gtest/libsecurity_pkix_test_gtest.a ../../../security/pkix/test/lib/libpkixtestutil.a ../../../security/certverifier/tests/gtest/libsecurity_certverifier_tests_gtest.a ../../../xpcom/glue/tests/gtest/libxpcom_glue_tests_gtest.a ../../../xpcom/tests/gtest/libxpcom_tests_gtest.a ../../../intl/unicharutil/tests/libintl_unicharutil_tests.a ../../../testing/gtest/libgtest.a ../../../caps/tests/gtest/libcaps_tests_gtest.a ../../../gfx/layers/apz/test/gtest/libgfx_layers_apz_test_gtest.a ../../../gfx/tests/gtest/libgfx_tests_gtest.a ../../../image/test/gtest/libimagetest.a ../../../dom/base/test/gtest/libdom_base_test_gtest.a ../../../dom/canvas/gtest/libdom_canvas_gtest.a ../../../dom/media/mediasource/gtest/libdom_media_mediasource_gtest.a ../../../dom/media/gtest/libdom_media_gtest.a ../../../dom/workers/test/gtest/libdom_workers_test_gtest.a ../../../layout/base/gtest/liblayout_base_gtest.a ../../../tools/profiler/tests/gtest/libtools_profiler_tests_gtest.a ../../../security/manager/ssl/tests/gtest/libsecurity_manager_ssl_tests_gtest.a ../../../toolkit/components/url-classifier/tests/gtest/libtoolkit_components_url-classifier_tests_gtest.a ../../../devtools/shared/heapsnapshot/tests/gtest/libdevtoolstests.a ../../../media/gmp-clearkey/0.1/gtest/libmedia_gmp-clearkey_0.1_gtest.a ../../../media/mtransport/test/libmedia_mtransport_test.a ../../../build/unix/stdc++compat/libstdc++compat.a ../../../memory/fallible/libfallible.a ../../../toolkit/library/libxul_s.a librul.a ../../../media/libstagefright/libmedia_libstagefright.a ../../../security/nss/lib/nss/libnss3.so ../../../security/nss/lib/smime/libsmime3.so ../../../security/nss/lib/ssl/libssl3.so ../../../security/nss/lib/util/libnssutil3.so ../../../config/external/sqlite/libmozsqlite3.so ../../../config/external/nspr/pr/libnspr4.so ../../../config/external/nspr/libc/libplc4.so ../../../config/external/nspr/ds/libplds4.so ../../../config/external/lgpllibs/liblgpllibs.so ../../../widget/gtk/mozgtk/stub/libmozgtk_stub.so     -lm -ldl -L/home/worker/workspace/build/src/gtk3/usr/lib64 -lfreetype -L/home/worker/workspace/build/src/gtk3/usr/local/lib -lfontconfig -lrt  -lXrender -lXext -lXdamage -lXfixes -lXcomposite -lasound -L/home/worker/workspace/build/src/gtk3/lib64 -ldbus-glib-1 -ldbus-1 -lpthread -lgobject-2.0 -lglib-2.0 -lpangocairo-1.0 -lpango-1.0 -latk-1.0 -lcairo-gobject -lcairo -lgdk_pixbuf-2.0 -lgio-2.0 -lX11 -lpangoft2-1.0 -lXt -lgthread-2.0



* I think the fixed compilation should as something like:

/home/worker/workspace/build/src/obj-firefox/_virtualenv/bin/python /home/worker/workspace/build/src/config/expandlibs_exec.py --uselist --  /usr/bin/ccache /home/worker/workspace/build/src/clang/bin/clang++ -std=gnu++11 -Qunused-arguments  -Qunused-arguments -Wall -Wc++11-compat -Wempty-body -Wignored-qualifiers -Woverloaded-virtual -Wpointer-arith -Wsign-compare -Wtype-limits -Wunreachable-code -Wwrite-strings -Wc++11-compat-pedantic -Wc++14-compat -Wc++14-compat-pedantic -Wc++1z-compat -Wclass-varargs -Wimplicit-fallthrough -Wloop-analysis -Werror=non-literal-null-conversion -Wstring-conversion -Wthread-safety -Wno-invalid-offsetof -Wno-inline-new-delete -Wno-error=deprecated-declarations -Wno-error=array-bounds -Wno-unknown-warning-option -Wno-return-type-c-linkage -O2 -flto -fsanitize=cfi-vcall -fsanitize-cfi-cross-dso -fno-exceptions -fno-strict-aliasing -fno-rtti -ffunction-sections -fdata-sections -fno-exceptions -fno-math-errno -pthread -D_GLIBCXX_USE_CXX11_ABI=0 -pipe  -g -fno-omit-frame-pointer  -Werror -fPIC -shared -Wl,-h,libxul.so -o libxul.so   ../StaticXULComponentsStart.o   librul.a   -lpthread -O2 -flto -fsanitize=cfi-vcall -fsanitize-cfi-cross-dso -ldl -Wl,-z,noexecstack -Wl,-z,text -Wl,--build-id -Wl,-version-script,symverscript    -Wl,-rpath-link,/home/worker/workspace/build/src/obj-firefox/dist/bin -Wl,-rpath-link,/usr/local/lib  ../../../memory/volatile/tests/libmemory_volatile_tests.a ../../../media/libstagefright/gtest/libstagefright_gtest.a ../../../security/sandbox/linux/gtest/libsandboxtest.a ../../../security/pkix/test/gtest/libsecurity_pkix_test_gtest.a ../../../security/pkix/test/lib/libpkixtestutil.a ../../../security/certverifier/tests/gtest/libsecurity_certverifier_tests_gtest.a ../../../xpcom/glue/tests/gtest/libxpcom_glue_tests_gtest.a ../../../xpcom/tests/gtest/libxpcom_tests_gtest.a ../../../intl/unicharutil/tests/libintl_unicharutil_tests.a ../../../testing/gtest/libgtest.a ../../../caps/tests/gtest/libcaps_tests_gtest.a ../../../gfx/layers/apz/test/gtest/libgfx_layers_apz_test_gtest.a ../../../gfx/tests/gtest/libgfx_tests_gtest.a ../../../image/test/gtest/libimagetest.a ../../../dom/base/test/gtest/libdom_base_test_gtest.a ../../../dom/canvas/gtest/libdom_canvas_gtest.a ../../../dom/media/mediasource/gtest/libdom_media_mediasource_gtest.a ../../../dom/media/gtest/libdom_media_gtest.a ../../../dom/workers/test/gtest/libdom_workers_test_gtest.a ../../../layout/base/gtest/liblayout_base_gtest.a ../../../tools/profiler/tests/gtest/libtools_profiler_tests_gtest.a ../../../security/manager/ssl/tests/gtest/libsecurity_manager_ssl_tests_gtest.a ../../../toolkit/components/url-classifier/tests/gtest/libtoolkit_components_url-classifier_tests_gtest.a ../../../devtools/shared/heapsnapshot/tests/gtest/libdevtoolstests.a ../../../media/gmp-clearkey/0.1/gtest/libmedia_gmp-clearkey_0.1_gtest.a ../../../media/mtransport/test/libmedia_mtransport_test.a ../../../build/unix/stdc++compat/libstdc++compat.a ../../../memory/fallible/libfallible.a ../../../toolkit/library/libxul_s.a librul.a ../../../media/libstagefright/libmedia_libstagefright.a ../../../security/nss/lib/nss/libnss3.so ../../../security/nss/lib/smime/libsmime3.so ../../../security/nss/lib/ssl/libssl3.so ../../../security/nss/lib/util/libnssutil3.so ../../../config/external/sqlite/libmozsqlite3.so ../../../config/external/nspr/pr/libnspr4.so ../../../config/external/nspr/libc/libplc4.so ../../../config/external/nspr/ds/libplds4.so ../../../config/external/lgpllibs/liblgpllibs.so ../../../widget/gtk/mozgtk/stub/libmozgtk_stub.so     -lm -ldl -L/home/worker/workspace/build/src/gtk3/usr/lib64 -lfreetype -L/home/worker/workspace/build/src/gtk3/usr/local/lib -lfontconfig -lrt  -lXrender -lXext -lXdamage -lXfixes -lXcomposite -lasound -L/home/worker/workspace/build/src/gtk3/lib64 -ldbus-glib-1 -ldbus-1 -lpthread -lgobject-2.0 -lglib-2.0 -lpangocairo-1.0 -lpango-1.0 -latk-1.0 -lcairo-gobject -lcairo -lgdk_pixbuf-2.0 -lgio-2.0 -lX11 -lpangoft2-1.0 -lXt -lgthread-2.0